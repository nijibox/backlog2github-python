#!/usr/bin/env python
from __future__ import unicode_literals
import os
import ConfigParser
import argparse
import yaml
from backlog import Project, Api as BacklogApi


CONFIG_DEFAULT_PATH = os.path.join(
    os.path.dirname(__file__),
    'app.ini',
)

config = ConfigParser.ConfigParser()
config.read(CONFIG_DEFAULT_PATH)

parser = argparse.ArgumentParser()
parser.add_argument('key', type=str)
parser.add_argument('--filter', type=str, required=False)

args = parser.parse_args()

backlog = BacklogApi(config.get('Backlog', 'space_id'), config.get('Backlog', 'api_key'))

if '-' in args.key:
    # key is issue
    issue = backlog.get_issue(args.key)
    issue_dir = './{}'.format(args.key)
    if not os.path.exists(issue_dir):
        os.makedirs(issue_dir)
    detail_path = os.path.join(issue_dir, 'Detail.yml')
    with open(detail_path, 'w') as fp:
        yaml.safe_dump(issue._data, fp, allow_unicode=True, default_flow_style=False)
    # Dump comments
    comments_dir = '{}/{}'.format(issue_dir, 'comments')
    if not os.path.exists(comments_dir):
        os.makedirs(comments_dir)
    comments = issue.get_comments()
    for comment in comments:
        comment_path = os.path.join(comments_dir, '{}.yml'.format(comment._data['id']))
        with open(comment_path, 'w') as fp:
            yaml.safe_dump(comment._data, fp, allow_unicode=True, default_flow_style=False)
    # Dump attachments
    attachment_dir = '{}/{}'.format(issue_dir, 'attachments')
    if not os.path.exists(attachment_dir):
        os.makedirs(attachment_dir)
    attachments = issue.get_attachments()
    for attachment in attachments:
        attachment.download(attachment_dir)
    # print(issue['summary'])
    # print('========')
    # print(issue['description'])
else:
    # key is project
    project = Project.from_api(args.key, backlog)
    issues = project.get_issues()
    for issue in issues:
        print(u'{}: {}'.format(issue['issueKey'], issue['summary']))
        # print('\n')
